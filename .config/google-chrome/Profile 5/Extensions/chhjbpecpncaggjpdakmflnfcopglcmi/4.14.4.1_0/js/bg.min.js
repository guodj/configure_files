/*! 
 * Ebates Button v4.14.4.1 2017-03-15
 * Copyrights 2016 Ebates Inc.
 */
"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function AnimatedIcon(a){var b=this;CanvasRenderingContext2D.prototype.roundRect=function(a,b,c,d,e,f,g){var h={upperLeft:0,upperRight:0,lowerLeft:0,lowerRight:0};if(void 0===g&&(g=!0),"object"===(void 0===e?"undefined":_typeof(e)))for(var i in e)h[i]=e[i];this.beginPath(),this.moveTo(a+h.upperLeft,b),this.lineTo(a+c-h.upperRight,b),this.quadraticCurveTo(a+c,b,a+c,b+h.upperRight),this.lineTo(a+c,b+d-h.lowerRight),this.quadraticCurveTo(a+c,b+d,a+c-h.lowerRight,b+d),this.lineTo(a+h.lowerLeft,b+d),this.quadraticCurveTo(a,b+d,a,b+d-h.lowerLeft),this.lineTo(a,b+h.upperLeft),this.quadraticCurveTo(a,b,a+h.upperLeft,b),this.closePath(),g&&this.stroke(),f&&this.fill()};var c=$.extend({speed:100,minValue:6,maxValue:12,stopValue:8.75,count:0,callback:null},a),d=c.minValue,e=0,f=void 0,g=$('<canvas id="canvas" width="38" height="38"></canvas>').get(0),h=g.getContext("2d"),i="Chrome"===framework.browser.name?"https://www.ebates.com/toolbar/images/icon76x76.png":"/img/icon76x76.png",j=function(a){var b=new Image(38,38);return new Promise(function(c,d){b=new Image(38,38),b.src=a,b.onload=c,b.onerror=d})},k=function(){return j(i).catch(function(){return j("/img/icon76x76.png")}).then(function(a){b.img=a.target})};["Chrome","Firefox"].indexOf(framework.browser.name)>=0&&(k().then(function(){b.stop("neutral")}),window.setInterval(k,36e5));var l=function(a,c,d){try{h.clearRect(0,0,38,38);return"activated"===c?(h.lineWidth=3,h.strokeStyle="#2EAF12",h.fillStyle="#FFF",h.roundRect(19-4*a/2,19-4*a/2,4*a,4*a,{upperLeft:4,upperRight:4,lowerLeft:4,lowerRight:4},!!d)):"available"===c&&(h.lineWidth=3,h.fillStyle="#ff3300",h.strokeStyle="#ff3300",h.roundRect(19-4*a/2,19-4*a/2,4*a,4*a,{upperLeft:4,upperRight:4,lowerLeft:4,lowerRight:4},!!d)),h.drawImage(b.img,0,0,38,38),g.toDataURL()}catch(a){}};this.play=function(a){if(["Safari","Edge"].indexOf(framework.browser.name)!=-1)return void framework.ui.button.setIcon(icons[a.type]);b.stop(),c=$.extend(c,a),f=window.setInterval(function(){b.next()},c.speed)},this.stop=function(a){f&&window.clearInterval(f),d=c.minValue,e=0,c.callback=null,a&&(["Safari","Edge"].indexOf(framework.browser.name)!=-1?framework.ui.button.setIcon(icons[a]):framework.ui.button.setIcon(l(c.stopValue,a,!0)))},this.next=function(){if(++d>=c.maxValue&&(d=c.minValue,e++),c.count&&e>c.count&&d>=c.stopValue)return e=0,b.stop(c.type),c.callback&&c.callback(),!1;framework.ui.button.setIcon(l(d,c.type))}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function handlePage(a){if(EBATES)if(a.url&&0===a.url.indexOf("http")){currentUrl=a.url,currentTab=a.tabId;var b=EBATES.merchants.match(a.url);b&&!EBATES.trackingTicketNumber&&EBATES.settings.affiliates.activations.clear(a.tabId),b&&b.get("settings_icon")&&!b.get("suppressed")?b.get("activated")?b.get("notification")?EBATES.icon.play({type:"activated",count:2}):EBATES.icon.stop("activated"):EBATES.icon.play({type:"available",count:4,callback:function(){EBATES.icon.stop("available")}}):EBATES.icon.stop("neutral")}else currentUrl=a.url||"",currentTab=a.tabId,EBATES.icon.stop("neutral")}function substitute(a){return a.replace(/%domain%?/g,domain).replace(/%api%?/g,api).replace(/%version%?/g,framework.extension.version).replace(/%browser%?/g,framework.browser.name.toLowerCase()).replace(/%installVersion%?/g,installVersion).replace(/%userid%?/g,toolbarId).replace(/%toolbarId%?/g,toolbarId).replace(/%uid%?/g,EBATES?EBATES.member.id:null).replace(/%userToken%?/g,autoLoginId).replace(/%autologinid%?/g,autoLoginId)}function getCurrentTab(a){webext?webext.tabs.query({currentWindow:!0,active:!0},function(b){a(b.pop())}):safari&&a(safari.application.activeBrowserWindow.activeTab)}function login(a){if("ButtonClick"===a.name){var b=EBATES.merchants.match(currentUrl);window.stat(["_trackEvent",b?b.get("domainName"):"Popup","Clicked",("ButtonClick"==a.name?"Popup":"Slider")+"Login"])}framework.browser.navigate({url:substitute(URL.WEB_LOGIN)})}var DEBUG=!1;framework.extension.filename="ebates";var domain="www.ebates.com",api="apituner.ecbsn.com",URL={BASE:"https://%domain%",STORES:"https://%api%/apituner/button/domain/entity/list",STORE_REWARDS:"https://%api%/apituner/button/store/reward",STORE_DEALS_COUNT:"https://%api%/apituner/button/store/deal/count",DEALS:"https://%api%/apituner/button/store/deal/list",STORE_DEALS:"https://%api%/apituner/button/store/deal/list?storeId={storeId}",CAMPAIGNS:"https://%api%/apituner/button/campaign/list",MEMBER_DETAILS:"https://%domain%/button/member/details?userToken=%userToken",MEMBER_CCINFO:"https://%domain%/button/member/ccinfo?userToken=%userToken",MEMBER_FAVORITES:"https://%domain%/button/member/store/favorite?userToken=%userToken",MEMBER_VISITED:"https://%domain%/button/member/store/visited?userToken=%userToken",MEMBER_PURCHASED:"https://%domain%/button/member/store/purchased?userToken=%userToken",MEMBER_TICKETS:"https://%domain%/button/member/trackingticket/list?userToken=%userToken",MEMBER_BONUSES:"https://%domain%/button/member/bonus/list?userToken=%userToken",MEMBER_ACTIVATE_BONUS:"https://%domain%/button/member/bonus/activate?userToken=%userToken&promo_id=%bonusID",CAPTURE_ORDER:"https://%api%/apituner/commercecapture/",LOG:"https://bl.ecbsn.com/index.php",AUTH:"https://%domain%/googleOAuth2.htm?callback=onConnectCallback",SETTINGS:"https://%domain%/toolbar/config/settings.json",SETTINGS_TAF:"https://%api%/apituner/toolbar/taf",SETTINGS_COUPONS:"https://%domain%/toolbar/config/coupons.json",SETTINGS_CHECKOUT:"https://%domain%/toolbar/config/checkout.json",WEB_INSTALL:"https://%domain%/button/%browser/install/success.htm?toolbarId=%userid",WEB_LOGIN:"https://%domain%/auth/getLogonForm.do?eeid=26118",WEB_UNINSTALL:"https://ebates.typeform.com/to/vpmTfz",WEB_SEARCH:"https://%domain%/search/all.htm?tb=yes&AutoLoginID=%userToken&store_name={terms}",WEB_ACCOUNT:"https://%domain%/my-ebates.htm?tb=yes&AutoLoginID=%userToken&eeid=26117",WEB_REWARDS:"https://%domain%/pending-cash-back.htm?tb=yes&AutoLoginID=%userToken&eeid=26117",WEB_CASHBACK:"https://%domain%/cash-back-history.htm?tb=yes&AutoLoginID=%userToken&eeid=26117",WEB_HOME:"https://%domain%/?tb=yes&AutoLoginID=%userToken&eeid=26117",WEB_REFERRAL:"https://%domain%/referral/default.do",WEB_TAF:"https://%domain%/toolbar/taf/taf.html"},ModelBase=Backbone.Model.extend({toJSON:function(){return Utils.populateURLs(_.clone(this.attributes))}}),DynamicCollection=Backbone.Collection.extend({idle:!1,pending:!1,nextUpdateTime:0,timeout:null,errorAttempt:0,dynamic:!0,MAX_ERROR_ATTEMPT:4,DEFAULT_UPDATE_INTERVAL:9e5,ERROR_UPDATE_INTERVAL:3e4,UPDATE_INTERVAL:null,initialize:function(){framework.extension.setItem(this.key+".busy",!1)},getCache:function(a){framework.extension.getItem(this.key,a)},setCache:function(a){framework.extension.setItem(this.key,a)},readCache:function(a){var b=this;return new Promise(function(c,d){b.key?a.reset||a.force?c():framework.extension.getItem(b.key+".busy",function(a){a?(b.dynamic&&(window.clearInterval(b.timeout),b.timeout=window.setInterval(function(){window.clearInterval(b.timeout),b.fetch().catch(function(a){})},5e3)),d()):(framework.extension.setItem(b.key+".busy",!0),framework.extension.getItem(b.key+".nextUpdateTime",function(a){b.getCache(function(e){if(e&&e.responseText&&_.now()<a){b.etag=e.etag;try{if(!b.length){var f=$.parseJSON(e.responseText);b.set(b.parse(f))}}catch(a){c()}finally{try{b.trigger("sync",b)}catch(a){}b.dynamic&&(window.clearInterval(b.timeout),b.timeout=window.setInterval(function(){b.fetch().catch(function(a){})},a-_.now())),framework.extension.setItem(b.key+".busy",!1),d()}}else c()})}))}):b.nextUpdateTime&&_.now()<b.nextUpdateTime?d():c()})},sync:function(a,b,c){var d=this;if("read"===a){var e=c||{};return window.clearInterval(b.timeout),new Promise(function(c,f){d.readCache(e).then(function(){b.etag&&!e.reset&&(e.beforeSend=function(a){return a.setRequestHeader("If-None-Match",b.etag)});var d=e.success;e.success=function(a,c,f){try{if(200==f.status){$.parseJSON(f.responseText.toString())}b.errorAttempt=0;var g=b.DEFAULT_UPDATE_INTERVAL;if(b.UPDATE_INTERVAL)g=b.UPDATE_INTERVAL;else{var h=f.getResponseHeader("Cache-Control");if(h&&h.indexOf("max-age=")>=0){var i=1e3*parseInt(f.getResponseHeader("Cache-Control").split("max-age=").pop().split(";").shift(),10);i>0&&(g=i)}}b.etag=f.getResponseHeader("ETag"),b.key&&f.responseText&&!e.force&&b.setCache({etag:b.etag,responseText:f.responseText.toString()}),b.key?(framework.extension.setItem(b.key+".busy",!1),framework.extension.setItem(b.key+".nextUpdateTime",_.now()+g)):b.nextUpdateTime=_.now()+g,b.dynamic&&(window.clearInterval(b.timeout),b.timeout=window.setInterval(function(){b.fetch(_.pick(e,"dataType"))},g)),d&&200==f.status?d.apply(b,arguments):b.trigger("sync",b)}catch(a){e.error(f)}},e.error=function(a){var c=10*Math.pow(3,b.errorAttempt>b.MAX_ERROR_ATTEMPT?b.errorAttempt:++b.errorAttempt)*1e3;b.key&&(framework.extension.setItem(b.key+".busy",!1),framework.extension.setItem(b.key+".nextUpdateTime",_.now()+c)),b.dynamic&&(window.clearInterval(b.timeout),b.timeout=window.setInterval(function(){b.fetch(_.pick(e,"dataType")).catch(function(){})},c)),b.trigger("error",b,a,e)},Backbone.Collection.prototype.sync.call(b,a,b,e).then(c,f)},function(){c()})})}return Backbone.Collection.prototype.sync.apply(b,arguments)},stop:function(){window.clearInterval(this.timeout),this.timeout=null,framework.extension.setItem(this.key+".nextUpdateTime",0)}});Backbone.cachedSync=function(a,b,c){var d=c||{};if("read"===a){if(_.now()<b.nextUpdateTime&&!d.reset)return new Promise(function(a){b.trigger("sync",b,null,d),a()});if(b.loading)return new Promise(function(a){b.once("sync",function(){b.trigger("sync",b,null,d),a()})});b.ETag&&(d.beforeSend=function(a){a.setRequestHeader("If-None-Match",b.ETag)}),this.loading=!0;var e=d.success;d.success=function(a,c,f){b.loading=!1,b.nextUpdateTime=_.now()+b.timeout,b.ETag=f.getResponseHeader("ETag"),304!==f.status?e&&e.apply(b,arguments):b.trigger("sync",b,a,d)};var f=d.error;d.error=function(){b.loading=!1,b.nextUpdateTime=_.now()+b.errorTimeout,f&&f.apply(b,arguments)}}return Backbone.sync.call(this,a,b,d)},window.CachedCollection=Backbone.Collection.extend({timeout:6e5,nextUpdateTime:0,initialize:function(a,b){_.extend(this,b)},stop:function(){this.nextUpdateTime=0},sync:function(){return Backbone.cachedSync.apply(this,arguments)}}),window.CachedModel=ModelBase.extend({timeout:18e5,errorTimeout:3e4,loading:!1,nextUpdateTime:0,sync:function(){return Backbone.cachedSync.apply(this,arguments)}}),window.LocallyStoredCollection=Backbone.Collection.extend({sync:function(a,b,c){return new Promise(function(d){"read"===a&&framework.extension.getItem(b.key,function(a){c.success(a),d()})})},save:function(){framework.extension.setItem(this.key,this.toJSON())}}),window.LocallyStoredModel=Backbone.Model.extend({sync:function(a,b,c){"read"===a?framework.extension.getItem(this.key,c.success):"update"!==a&&"create"!==a||framework.extension.setItem(this.key,_.clone(this.attributes))}}),window.ErrorsCollection=window.LocallyStoredCollection.extend({key:"errorscollection",successFetch:null,maxLength:100,sendInterval:36e5,errorsSyncedTimestamp:null,initialize:function(){var a=this;this.on({remove:this.save,add:function(){a.length>=a.maxLength&&(a.shift({silent:!0}),a.save())}}),this.fetch().then(function(){$(document).ajaxError(function(b,c,d,e){var f=void 0;f=e?200===c.status?e.message:c.responseJSON&&c.responseJSON.error?c.responseJSON.error.message:"":c.statusText+": no connection",a.add({code:"Network Error: "+c.status,source:d.url,details:f,timestamp:_.now()})}),$(window).on("error",function(b){a.add({code:"javascript",source:b.originalEvent.filename+":"+b.originalEvent.lineno,details:b.originalEvent.message,timestamp:_.now()})}),a.syncErrors()}),this.interval=window.setInterval(function(){a.syncErrors()},9e5)},syncErrors:function(){var a=this;framework.extension.getItem(this.key+".syncTimestamp",function(){var b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;_.now()>b+a.sendInterval&&(a.each(function(b){window.stat(["_trackEvent",b.get("code"),b.get("source"),b.get("details")]).then(function(){a.remove(b)})}),framework.extension.setItem(a.key+".syncTimestamp",_.now()))})}});var BonusModel=Backbone.Model.extend({idAttribute:"bonusID",initialize:function(){var a=this;if(this.get("bonusExpiration")){var b=_.max([moment(this.get("bonusExpiration")).diff(moment()),0]);b<2147483647&&(this.expirationTimeout=window.setInterval(function(){a.collection.remove(a)},b))}this.on("remove",function(){window.clearInterval(this.expirationTimeout)})},activate:function(){return $.ajax({url:substitute(URL.MEMBER_ACTIVATE_BONUS).replace("%bonusID",this.get("bonusID")),type:"POST"})}}),BonusesCollection=DynamicCollection.extend({key:"bonuses",model:BonusModel,ERROR_UPDATE_INTERVAL:6e5,DEFAULT_UPDATE_INTERVAL:864e5,blacklistedBonusIds:[667,668,669,670,771,718,719,720,721,722,772],blacklistedStoreIds:[],url:function(){return substitute(URL.MEMBER_BONUSES)},initialize:function(){},parse:function(a){var b=this;return _.filter(a.memberBonus,function(a){return!_.includes(b.blacklistedBonusIds,a.bonusID)&&0===_.intersection(a.storeIds,b.blacklistedStoreIds).length},this)}}),AffiliateLinkModel=Backbone.Model.extend({TIMEOUT:6e4,constructor:function(a){Backbone.Model.call(this,{url:a})},activate:function(a){var b=this;this.set({active:a}),_.delay(function(){return b.unset("active")},this.TIMEOUT)}}),AffiliateLinksCollection=Backbone.Collection.extend({model:AffiliateLinkModel,find:function(a){return"string"==typeof a?Backbone.Collection.prototype.find.call(this,function(b){return"string"==typeof b.get("url")?a.indexOf(b.get("url"))>0:b.get("url").test(a)}):Backbone.Collection.prototype.find.apply(this,arguments)},match:function(a,b){"Edge"===framework.browser.name&&(b=0);var c=this.find(a);return c&&c.activate(b),c},clear:function(a){"Edge"===framework.browser.name&&(a=0),this.where({active:a}).forEach(function(a){return a.unset("active")})},state:function(a){return"Edge"===framework.browser.name&&(a=0),this.findWhere({active:a})}}),AffiliateLinkStatus=Backbone.Model.extend({suppresses:new AffiliateLinksCollection,activations:new AffiliateLinksCollection([/^[^?]*\.ebates\.com\/.*(?:createShoppingSession|xfas|mall_ctrl\.do)/]),match:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;"Edge"===framework.browser.name&&(b=0);var c=this.activations.match(a,b);if(c)c.set({xfas:a,xfas_source:a.split("sourceName=").pop().split("&")[0]});else{this.suppresses.match(a,b)}},state:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return"Edge"===framework.browser.name&&(a=0),{tabId:a,activation:this.activations.state(a),suppress:this.suppresses.state(a)}},clear:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;"Edge"===framework.browser.name&&(a=0),this.suppresses.clear(a),this.activations.clear(a)}}),MerchantBaseModel=ModelBase.extend({getCashBackAmount:function(a){var b=a&&(a.amount||a.range)?a:this.get("totalReward");if(b){var c="";switch(b.display){case"Percentage":c=b.range&&b.range.high?"Up to "+b.range.high+"%":b.amount+"%";break;case"Fixed":c=b.range&&b.range.high?"Up to "+accounting.formatMoney(b.range.high):accounting.formatMoney(b.amount);break;case"Coupons":c="Offers Only";break;case"None":c="Not Available"}return c.replace(/\.0+/,"")}}}),MerchantModel=MerchantBaseModel.extend({DEFAULT_TIMEOUT:18e5,idAttribute:"matchPattern",deals:null,match:null,defaults:{activationCode:0,notification:!0,"notification-reminder":!1,"notification-checkout":!0,activated:!1,suppressed:!1},processCode:function(){var a=this.get("activationCode"),b=this.get("totalReward"),c=b&&["None","Coupons"].indexOf(b.display)<0&&(parseFloat(b.amount)>0||0===parseFloat(b.amount)&&b.range&&parseFloat(b.range.high)>0),d=_([3,5]).includes(a)&&c;this.set({settings_notification:3===a&&c||2===a,settings_confirmation:d,settings_serp:3===a&&c,settings_popup:d,settings_icon:d,settings_deals:d,settings_recent:d,settings_caa:d,settings_purchase:_([3,5]).includes(a),offers_cb:c})},processRX:function(){".*.*"!=this.get("matchPattern")&&(this.match=new RegExp(this.get("matchPattern"),"i"))},initialize:function(){if(this.collection&&this.has("storeId")&&!this.has("totalReward")){var a=this.collection.rewards.get(this.get("storeId"));a&&this.set(a.pick("totalReward"))}return this.processCode(),this.processRX(),this.set({"notification-reminder":this.get("affiliatizerEnabled"),topDomain:Utils.getDomain(this.get("domainName"))}),this.has("storeId")&&(this.deals=new DealsCollection([],{url:substitute(URL.STORE_DEALS).replace("{storeId}",this.get("storeId"))})),this.on({"change:totalReward":this.processCode,"change:activationCode":this.processCode,"change:matchPattern":this.processRX,"change:visit":function(a,b){b&&this.get("track_events")&&EBATES.log({event_type:"store_visit",location_flag:"merchant",merchant_id:this.get("storeId"),on_ebates:this.get("storeId")?"Y":"N",offers_cb:this.get("offers_cb")?"Y":"N",ebates_trip:this.get("ttn")?"Y":"N",tracking_ticket:this.get("ttn")})},"change:activated":function(a,b){if(!b&&(this.unset("sessionReward"),this.get("settings_recent"))){var c=this.toJSON(),d=this.collection.recent.findWhere({storeId:c.storeId});d&&d.set({cashBackAmount:c.cashBackAmount,cashBackAmountWas:c.cashBackAmount,lastVisit:(new Date).getTime()},{merge:!0})}},"change:state":function(a,b,c){"activated"===b?("toolbar"!=this.get("activation_source")&&EBATES.log({event_type:"activated_ebates_com",location_flag:"ebates",merchant_id:this.get("storeId"),tracking_ticket:this.get("ttn")}),this.set({notification:!0,"notification-reminder":!1,activated:!0,suppressed:!1,competitor:null}),this.resetTimeout(!0)):"suppressed"===b?("Chrome"===framework.browser.name&&this.has("tabId")&&EBATES.settings.get("features").takeover&&(framework.extension.fireEvent("takeover",{tabId:this.get("tabId"),data:this.toJSON()}),EBATES.log({event_type:"shopping_trip_deactivated",merchant_id:this.get("storeId"),competitor_domain:this.get("competitor"),tracking_ticket:this.get("ttn")})),this.set({activated:!1,notification:!1,"notification-reminder":!1,"notification-checkout":!1,suppressed:!0,ttn:null,tabId:null}),this.resetTimeout()):this.set({visit:!1,notification:!0,"notification-reminder":!0,"notification-checkout":!0,activated:!1,suppressed:!1,ttn:null,tabId:null,competitor:null})}}),ModelBase.prototype.initialize.call(this)},toJSON:function(){var a=this,b=EBATES.member.bonuses.chain().filter(function(b){return b.get("bonusActive")&&b.get("storeIds").includes(a.get("storeId"))}).invoke("toJSON").value(),c=EBATES.settings.promos.findWhere({active:!0,hover:!0});if(c&&c.campaigns){var d=c.campaigns.findWhere({hover:!0});d&&d.stores.findWhere(this.pick("storeId"))&&b.push({type:"promo",bonusDescription:c.get("description"),bonusExpiration:c.get("expires")})}var e=EBATES.merchants.recent.findWhere(this.pick("storeId"));return _.extend(ModelBase.prototype.toJSON.apply(this,arguments),e?e.attributes:null,{cashBackAmount:this.getCashBackAmount(this.get("sessionReward")),loggedIn:EBATES.loggedIn,bonuses:b})},resetTimeout:function(a){var b=this;this.set("visit",!0),window.clearInterval(this.timeout),this.timeout=window.setInterval(function(){window.clearInterval(b.timeout),b.unset("state")},this.DEFAULT_TIMEOUT)},activate:function(a){function b(a,b){if(a=a.replace("&store_url=%deepLinkUrl%",""),a.indexOf("store_url")<0&&b&&c.get("affiliatizerEnabled")){var d=a;a+=b?"&store_url="+encodeURIComponent(b):"",a.length>=2048&&(a=d)}framework.browser.navigate({url:a})}var c=this,d=a&&a.url?a.url.replace(/[&?](?:LinkshareID|siteID)=.*/i,"").replace(/=[\w\.-]+@[\w-]+\.\w{2,}/g,"="):"";switch(parseInt(this.get("activationCode"))){case 2:if(this.has("storeLandingURL")){b(this.toJSON().storeLandingURL+"&tb=yes&sourceName=toolbar&eeid=23509");break}case 5:if(this.has("storeLandingURL")){b(this.toJSON().storeLandingURL,d);break}default:b(c.toJSON().shoppingURL+"&tb=yes&sourceName=toolbar&eeid=23509",d)}}}),RecentStoreModel=MerchantBaseModel.extend({idAttribute:"storeId",defaults:{cashBackDifference:0,lastVisit:(new Date).getTime()},initialize:function(){this.on("add change:cashBackAmount change:cashBackAmountWas",function(){if(this.get("cashBackAmount")&&this.get("cashBackAmountWas")){var a=parseFloat(this.get("cashBackAmount").replace(/[^\d\.]/g,"")),b=parseFloat(this.get("cashBackAmountWas").replace(/[^\d\.]/g,""));a?this.set({cashBackDifference:a-b}):this.collection.remove(this)}})},toJSON:function(){var a=EBATES.merchants.findWhere({storeId:this.get("storeId")});return a?_.extend(a.toJSON(),MerchantBaseModel.prototype.toJSON.apply(this,arguments)):MerchantBaseModel.prototype.toJSON.apply(this,arguments)}}),RecentStoresCollection=LocallyStoredCollection.extend({model:RecentStoreModel,comparator:function(a,b){return a.get("cashBackDifference")===b.get("cashBackDifference")?a.get("lastVisit")>b.get("lastVisit")?-1:1:a.get("cashBackDifference")>b.get("cashBackDifference")?-1:1},key:"recent",size:24,initialize:function(){this.on({add:function(){this.sort(),this.length>this.size&&this.pop(),this.save()},"change:cashBackDifference":function(a){this.filter(function(a){return a.get("cashBackDifference")>0}).length&&EBATES?EBATES.member.overlays.get("smart-cards")||this.length>=2&&EBATES.member.overlays.add({id:"smart-cards",view:"TAFSmartCardsOverlayView",shown:!1}):EBATES&&EBATES.member.overlays.get("smart-cards")&&!EBATES.member.overlays.get("smart-cards").get("shown")&&EBATES.member.overlays.remove(EBATES.member.overlays.get("smart-cards"))}})},save:function(){framework.extension.setItem(this.key,this.map(function(a){return a.attributes}))},visit:function(a){var b=a.toJSON();this.add({storeId:b.storeId,cashBackAmount:b.cashBackAmount,cashBackAmountWas:b.cashBackAmount,lastVisit:(new Date).getTime()},{merge:!0})}}),MerchantRewardModel=Backbone.Model.extend({idAttribute:"storeId"}),MerchantRewardsCollection=DynamicCollection.extend({model:MerchantRewardModel,DEFAULT_UPDATE_INTERVAL:18e4,dynamic:!1,initialize:function(){var a=this;framework.extension.attachEvent("updateRewards",function(){a.fetch().catch(function(a){})})},url:function(){return substitute(URL.STORE_REWARDS)},parse:function(a){return a.storeReward}}),MerchantsCollection=DynamicCollection.extend({url:function(){return substitute(URL.STORES)},model:MerchantModel,key:"merchants",recent:new RecentStoresCollection,rewards:new MerchantRewardsCollection,rewardsSynced:!1,initialize:function(){var a=this;return this.on({sync:function(){this.updateAttributes(),void 0!==EBATES&&this.add(EBATES.settings&&EBATES.settings.domains||[],{merge:!0,remove:!1})},remove:function(a){this.recent.get(a.get("storeId"))&&this.recent.remove(a.get("storeId"))}}),this.listenTo(this.rewards,{"change:totalReward add":function(a){this.where({storeId:a.id}).forEach(function(b){return b.set(a.pick("totalReward"))})},remove:function(a){var b=this;this.remove(a.id),this.where({storeId:a.id}).forEach(function(a){return b.remove(a)})},request:function(){this.rewardsUpdating=!0},sync:function(){this.rewardsSynced=!0,this.rewardsUpdating=!1,this.updateRecent(),this.trigger("sync-rewards")}}),this.recent.fetch().catch(function(a){}),this.fetch().catch(function(a){}),framework.extension.attachEvent("getMerchant",function(b,c){if(b.url.indexOf(".ebates.com/")<0&&EBATES){var d=a.match(b.url);d?a.rewards.fetch().catch(function(a){}).then(function(){autoLoginId&&d.get("settings_recent")&&a.recent.visit(d),"Safari"===framework.browser.name&&b.data&&!b.data.referrer&&!b.data.search.length&&b.data.pathname.length<20&&d.has("state")&&(d.unset("state"),d.get("settings_icon")&&EBATES.icon.stop("available"));var e=EBATES.settings.affiliates.state(b.tabId);if(e.activation||e.suppress){if(e.activation)EBATES.loggedIn&&(EBATES.activate(d,b.tabId,e.activation),b.tabId===currentTab&&EBATES.icon.play({type:"activated",count:2}));else if(e.suppress){var f=null;EBATES.session_competition&&(f=EBATES.session_competition.domain,EBATES.log(EBATES.session_competition),EBATES.log({event_type:"competitive_activate",location_flag:"competition",url:b.url}),EBATES.session_competition=null),d.set({competitor:f,state:"suppressed"}),b.tabId===currentTab&&EBATES.icon.stop("neutral")}EBATES.settings.affiliates.clear(b.tabId)}d.get("activated")&&b.tabId&&d.set({tabId:b.tabId}),d.resetTimeout(),c(_.extend(d.toJSON(),{blacklisted:EBATES.settings.get("blacklistEnabled")&&EBATES.settings.blacklist.contains(b.url)}))}):c(null)}return!0}),framework.extension.attachEvent("getStores",function(a,b){b(_.map(a.data,function(a){var b=EBATES.merchants.findWhere({storeId:a});return b&&b.toJSON()}))}),framework.extension.attachEvent("getStore",function(b,c){if(b.url.indexOf(domain)<0){var d=a.match(b.data.url);c(d?d.toJSON():null)}else c(null)}),framework.extension.attachEvent("activate",function(b){var c=a.findWhere({storeId:b.data.storeId});c&&c.activate(b)}),framework.extension.attachEvent("set",function(a){if(a.data){var b=EBATES.merchants.match(a.url);b&&b.set(a.data)}}),DynamicCollection.prototype.initialize.apply(this,arguments)},fetch:function(a){return DynamicCollection.prototype.fetch.call(this,_.extend({add:!0,merge:!0,remove:!0},a))},merge:function(a){var b=this;a.forEach(function(a){return b.where({storeId:a.storeId}).forEach(function(b){return b.set(a)})})},updateAttributes:function(){var a=this;return this.rewards.fetch().catch(function(a){}).then(function(){return a.attributesUpdated=!0})},updateRecent:function(){for(var a=this.recent.length-1;a>=0;a--){var b=this.recent.at(a),c=this.findWhere({storeId:b.get("storeId")});if(c){var d=c.toJSON().cashBackAmount;d&&b.set({cashBackAmount:d})}else this.recent.remove(b)}this.recent.sort(),this.recent.save()},match:function(a){var b=this.where({topDomain:Utils.getDomain(a)}).filter(function(b){return b.match&&b.match.test(a)});return b.length?_.max(b,function(a){return a.match.source.length}):null},search:function(a){return _.chain(this.filter(function(b){return b.get("offers_cb")&&b.get("settings_popup")&&0===b.get("storeName").toLowerCase().indexOf(a)})).invoke("toJSON").value()},parse:function(a,b){return a.domainEntities}}),StoreDetailsCollection=CachedCollection.extend({fetch:function(a){var b=this;return EBATES.merchants.length&&EBATES.merchants.rewardsSynced?CachedCollection.prototype.fetch.call(this,a):new Promise(function(c,d){EBATES.merchants.length&&!EBATES.merchants.rewardsUpdating&&EBATES.merchants.updateAttributes(),EBATES.merchants.once("sync-rewards",function(){b.fetch(a).then(c,d)})})}}),DealModel=ModelBase.extend({store:null,defaults:{storeId:11095},initialize:function(){this.get("code")&&this.get("code").indexOf("&amp;")&&this.set({code:this.get("code").replace("&amp;","&")})},toJSON:function(){var a=EBATES.merchants.findWhere({storeId:this.get("storeId")});if(a&&a.get("shoppingURL")){var b=a.toJSON();return _.extend(ModelBase.prototype.toJSON.apply(this,arguments),_.pick(b,"images","storeName","cashBackAmount","totalReward"),{shoppingURL:b.shoppingURL.replace("&store_url=%deepLinkUrl%","")+"&special="+this.id+"&tb=yes&domainName="+b.domainName+"&sourceName=toolbar&toolbarFeatureId=DDD&eeid=26141"})}return null}}),DealsCollection=StoreDetailsCollection.extend({model:DealModel,comparator:function(a){return[a.has("code")?0:1,["Store Wide","Department","Free Gift","Free Shipping","Product",void 0].indexOf(a.get("scope")),a.get("scores")?a.get("scores").score1:0]},parse:function(a){return _.chain(a.storeDeals).map(function(a){return _.map(a.deals,function(b){return _.extend({storeId:a.storeId},b)})}).flatten().value()},search:function(a){return _.chain(this.filter(function(b){return b.get("description").toLowerCase().indexOf(a)>=0})).invoke("toJSON").value()}}),OneReceiptOrderModel=Backbone.Model.extend({idAttribute:"id"}),OneReceiptCollection=DynamicCollection.extend({key:"orders",dynamic:!1,DEFAULT_UPDATE_INTERVAL:144e5,ERROR_UPDATE_INTERVAL:6e4,model:OneReceiptOrderModel,url:function(){return substitute("https://%domain/button/member/receipts/list?userToken=%userToken")},initialize:function(){var a=this;this.on("sync",function(){a.where({merchant:"PayPal"}).forEach(function(b){a.where(b.pick("orderDate","orderTotal")).length>1&&a.remove(b)})})},parse:function(a){return a.data?(EBATES.member.orders.set({linked:!0}),this.meta=a.data.meta,_.chain(a.data.objects).map(function(a){var b="purchased",c="";if(!EBATES.settings.ordersIgnoreList.includes(a.merchant)){if(a.tracking_numbers&&a.tracking_numbers.length){var d=a.tracking_numbers[0];c=d.url,b=d.status.indexOf("Delivered")>=0?"delivered":"shipped"}return{id:a.order_id,orderDate:moment(a.purchased_on).toDate(),orderTotal:a.transactions?a.transactions.grand_total:0,status:b,trackingUrl:c,deliveryEstimate:"",merchant:a.merchant,company_logo:a.company_logo,items:_.chain(a.items).map(function(a){return a.name?{name:a.name,imageUrl:a.image_src,category:a.category,price:a.transactions?a.transactions.price:0}:null}).compact().value()}}}).filter(function(a,b,c){return a&&a.orderTotal&&a.items.length}).value()):(EBATES.member.orders.set({linked:!1}),null)}}),OneReceiptModel=LocallyStoredModel.extend({key:"ore",defaults:{access_token:""},orders:new OneReceiptCollection,fetch:function(a){framework.browser.name},isTokenExpired:function(){return!1},login:function(a){function b(d){var e=d.url;if(0===e.search(substitute("https?://%domain/googleOAuth2callback.htm"))){var f=_.reduce(e.substr(e.search("#")+1).split("&"),function(a,b){var c=b.split("=");return a[c[0]]=c[1],a},{});framework.browser.navigate({url:substitute("https://%domain/connectEbatesUserWithGoogle.htm?code="+f.code),tabId:d.tabId}),_.delay(function(){c.enableOneReceiptConnection().then(a),framework.browser.detachEvent(framework.browser.BEFORENAVIGATE,b),framework.browser.navigate({url:"https://www.ebates.com/toolbar/my_orders/success.htm",tabId:d.tabId}),stat(["_trackPageview","/virtual/MyOrders/success_page"])},1e3)}}var c=this;if(this.has("access_token"))return this.set({access_token:autoLoginId}),!1;return window.open(substitute(URL.AUTH),"popup","toolbar=0,resizable=1,left="+parseInt((screen.availWidth-500)/2)+",top="+parseInt((screen.availHeight-680)/2)+",width=500,height=680"),stat(["_trackPageview","/virtual/MyOrders/auth_page"]),framework.browser.attachEvent(framework.browser.BEFORENAVIGATE,b),_.delay(function(){framework.browser.detachEvent(framework.browser.BEFORENAVIGATE,b)},9e5),!0},updateTokens:function(){},loadOrders:function(a){return this.orders.access_token=this.get("access_token"),this.orders.fetch(a)},enableOneReceiptConnection:function(){var a=this;return $.ajax({url:substitute("https://%domain/enableOneReceiptConnection.do"),beforeSend:function(a){a.setRequestHeader("Sent-From","ebates"),a.setRequestHeader("X-Requested-With","XMLHttpRequest")},method:"POST",success:function(b){"enabled_ok"!==b.oneReceiptSuccessKey&&0!==_.keys(b).length||a.save({access_token:autoLoginId})}})}}),OverlayModel=Backbone.Model.extend({defaults:{badgeColor:"#EF5A4E",shown:!1}}),OverlaysCollection=LocallyStoredCollection.extend({key:"overlays",model:OverlayModel,initialize:function(){this.fetch(),this.on("add remove change:shown",function(a){var b=this.where({shown:!1}).length;b>0?framework.ui.button.setBadgeText(b):framework.ui.button.setBadgeText("")})}}),TrackingTicketsCollection=CachedCollection.extend({key:"trackingtickets",url:function(){return substitute(URL.MEMBER_TICKETS)},parse:function(a){return _.flatten(a.tickets.ticket)}}),TopDealsCollection=DealsCollection.extend({url:function(){return substitute(URL.DEALS)},comparator:function(a){var b=EBATES.member.favorites.findWhere({storeId:a.get("storeId")});return b?(a.set({section:"favorite"}),
EBATES.member.favorites.indexOf(EBATES.member.favorites.findWhere({storeId:a.get("storeId")}))):(b=EBATES.member.purchased.findWhere({storeId:a.get("storeId")}))?(a.set({section:"purchased"}),EBATES.member.favorites.length+EBATES.member.purchased.indexOf(b)):(b=EBATES.member.visited.findWhere({storeId:a.get("storeId")}))?(a.set({section:"visited"}),EBATES.member.favorites.length+EBATES.member.purchased.length+EBATES.member.visited.indexOf(b)):(a.unset("section"),EBATES.member.favorites.length+EBATES.member.purchased.length+EBATES.member.visited.length+a.collection.indexOf(a))},fetch:function(){var a=this,b=arguments;return Promise.all([EBATES.member.favorites.fetch(),EBATES.member.purchased.fetch(),EBATES.member.visited.fetch()]).catch(function(){}).then(function(){return DealsCollection.prototype.fetch.apply(a,b)})}}),FavoritesCollection=StoreDetailsCollection.extend({url:function(){return substitute(URL.MEMBER_FAVORITES)},parse:function(a){return _.chain(a.storeFavorites).map(function(a){return _.extend({storeId:a.favoriteId},a)}).flatten().value()}}),VisitedStoresCollection=StoreDetailsCollection.extend({url:function(){return substitute(URL.MEMBER_VISITED)},parse:function(a){return a.visitedStores}}),PurchasedStoresCollection=StoreDetailsCollection.extend({url:function(){return substitute(URL.MEMBER_PURCHASED)},parse:function(a){return a.purchasedStores}}),TopStoreModel=MerchantBaseModel.extend({toJSON:function(){var a=EBATES.merchants.findWhere({storeId:this.get("storeId")});if(a&&a.has("shoppingURL")){var b=a.toJSON();return _.extend(ModelBase.prototype.toJSON.apply(this,arguments),b,{shoppingURL:b.shoppingURL.replace("&store_url=%deepLinkUrl%","")+"&merchantId="+b.storeId+"&tb=yes&domainName="+b.domainName+"&toolbarId="+toolbarId+"&sourceName=toolbar&toolbarFeatureId=TOPSTORES&eeid=26142"})}}}),MemberAccountSummaryModel=LocallyStoredModel.extend({key:"account",initialize:function(){this.on({"change:pendingAmount change:paidAmount":function(){var a=this.get("pendingAmount"),b=this.get("paidAmount");Number.isFinite(a)&&Number.isFinite(b)&&this.set({totalAmount:a+b})},"change:totalAmount":function(a,b){var c=a.get("totalAmount"),d=a.previous("totalAmount");Number.isFinite(d)&&Number.isFinite(c)&&c>d&&EBATES.member.trackingtickets.fetch().then(function(){var a=EBATES.member.trackingtickets.find(function(a){return a.has("memberReward")&&a.get("memberReward").amount});if(a&&a.get("storeId")&&!EBATES.member.messages.find(function(b){return b.get("memberReward")&&b.get("memberReward").amount===a.get("memberReward").amount})){var b=EBATES.merchants.findWhere(a.pick("storeId"));b&&b.get("storeName")&&EBATES.member.messages.add(_.extend(a.toJSON(),{text:"You just earned $"+a.get("memberReward").amount+" Cash Back from your purchase at "+b.get("storeName")+"! ",type:"cashback"}))}})}}),this.trigger("change:pendingAmount")}}),CCInfoModel=CachedModel.extend({timeout:864e5,defaults:{chStatus:!1,psStatus:!1,itaStatus:!1},url:function(){return substitute(URL.MEMBER_CCINFO)},initialize:function(){var a=this;framework.extension.attachEvent("getCCInfo",function(b,c){a.fetch().catch(function(){}).then(function(){return c(a.toJSON())})})},parse:function(a){return a.ccInfo}}),MemberDetailsModel=CachedModel.extend({url:function(){return substitute(URL.MEMBER_DETAILS)},initialize:function(){var a=this;this.overlays=new OverlaysCollection,this.bonuses=new BonusesCollection,this.trackingtickets=new TrackingTicketsCollection,this.favorites=new FavoritesCollection,this.visited=new VisitedStoresCollection,this.purchased=new PurchasedStoresCollection,this.topDeals=new TopDealsCollection,this.accountSummary=new MemberAccountSummaryModel,this.ccinfo=new CCInfoModel,this.messages=new MessagesCollection,this.orders=new OneReceiptModel,this.accountSummary.fetch(),this.on({change:function(a,b){b.unset&&(this.nextUpdateTime=0)},"change:id":function(a,b){this.id?this.previous("id")?(this.bonuses.fetch({reset:!0}),this.ccinfo.fetch({reset:!0}),this.favorites.stop(),this.visited.stop(),this.purchased.stop(),this.messages.reset(),this.orders.orders.stop()):this.bonuses.fetch():this.bonuses.stop()},"change:oneReceiptEnabled":function(a,b){"Chrome"===framework.browser.name&&b&&(EBATES.member.overlays.get("my-orders")||(EBATES.member.overlays.add({id:"my-orders",category:"My Orders",view:"MyOrdersOverlayView",tab:"#btnMyOrders"}),stat(["_trackEvent","My Orders","Display Badge"]),EBATES.member.overlays.save()))},error:function(a,b){400!==b.status&&401!==b.status||(this.clear(),autoLoginId=null,EBATES.init())}}),framework.extension.attachEvent("account",function(b,c){autoLoginId?a.fetch().catch(function(){}).then(function(){return c(a.toJSON())}):c()})},fetch:function(){if(autoLoginId)return $.when(this.ccinfo.fetch(),CachedModel.prototype.fetch.apply(this,arguments))},parse:function(a){return this.accountSummary.save(_.reduce(a.member.accountSummary,function(a,b,c){return a[c]=parseFloat(b),a},{})),delete a.member.accountSummary,a.member},toJSON:function(){return _.extend(CachedModel.prototype.toJSON.apply(this,arguments),{autoLoginId:autoLoginId,accountSummary:this.accountSummary.toJSON(),ccinfo:this.ccinfo.toJSON()})}});window.ProductParsersCollections=window.DynamicCollection.extend({key:"products",ERROR_UPDATE_INTERVAL:6e5,DEFAULT_UPDATE_INTERVAL:864e5,url:"https://www.ebates.com/toolbar/config/products.json",initialize:function(){var a=this;framework.extension.attachEvent("getProducts",function(b,c){c(a.toJSON())}),this.fetch()},parse:function(a){return a.stores}});var MessageModel=Backbone.Model.extend({defaults:{created:null,shown:!1,text:""},initialize:function(){var a=this;this.get("created")||this.set("created",_.now()),this.on("change:unread",function(){a.collection.trigger("change")})}}),MessagesCollection=LocallyStoredCollection.extend({key:"messages",model:MessageModel,initialize:function(){this.fetch({silent:!0}),this.on({"add remove change reset":function(){var a=this.where({shown:!1}).length;a>0?framework.ui.button.setBadgeText(a):framework.ui.button.setBadgeText(""),this.save()},add:function(a,b){stat(["_trackEvent","My Messages","Display Badge",b.where({shown:!1}).length])}})}}),PromoModel=Backbone.Model.extend({defaults:{popup:!1,badge:!1,shown:!1,active:!1},campaigns:null,initCampaigns:function(){this.has("campaigns")&&(this.campaigns||(this.campaigns=new PromoCampaignsCollection(null,{promo:this})),this.campaigns.set(this.get("campaigns")))},initTimeouts:function(){var a=this;if(this.has("expires")&&this.has("starts")){var b=_.now();this.timeout&&window.clearInterval(this.timeout),this.set({active:b>=moment(this.get("starts"))&&b<moment(this.get("expires"))});var c=function(a){return _.min([moment(a).diff(),6e5])},d=void 0;b<moment(this.get("starts"))?d=c(this.get("starts")):b<moment(this.get("expires"))&&(d=c(this.get("expires"))),d&&(this.timeout=window.setInterval(function(){a.initTimeouts()},d))}},initialize:function(){this.on({"change:campaigns":function(){this.initCampaigns()},"change:starts":function(){this.initTimeouts()},"change:active":function(a,b){b&&this.get("badge")&&!this.get("shown")&&framework.ui.button.setBadgeText("1")},"change:shown":function(a,b){b&&framework.ui.button.setBadgeText("")}}),this.initCampaigns(),this.initTimeouts()}}),PromosCollection=LocallyStoredCollection.extend({model:PromoModel,key:"promos",initialize:function(){this.on("add remove change",function(){this.save()})},getActive:function(){return this.find(function(a){return a.get("active")&&_.now()>=moment(a.get("starts"))&&_.now()<moment(a.get("expires"))})},save:function(){var a=this.map(function(a){return a.pick("id","shown","disabled")});framework.extension.setItem(this.key,a)}}),CampaignStoreModel=TopStoreModel.extend({toJSON:function(){return _.extend(TopStoreModel.prototype.toJSON.apply(this,arguments),{cashBackAmountWas:this.getCashBackAmount(this.get("baseReward"))})}}),CampaignStoresCollection=StoreDetailsCollection.extend({model:CampaignStoreModel,url:function(){return substitute(URL.CAMPAIGNS)+"?id="+this.id},initialize:function(a,b){this.id=b.id,this.campaign=b},parse:function(a){var b=a.campaigns.pop();if(b)return this.campaign=_.pick(b,["name","start","expires"]),b.stores}}),PromoCampaignModel=Backbone.Model.extend({defaults:{popup:!1,hover:!1},initialize:function(){var a=this;this.stores=new CampaignStoresCollection(null,this),this.listenTo(this.collection.promo,"change:active",function(b){b&&a.stores.fetch()}),this.collection.promo.get("active")&&this.stores.fetch(),this.collection.promo.set(this.pick(function(a){return a===!0}))}}),PromoCampaignsCollection=Backbone.Collection.extend({model:PromoCampaignModel,initialize:function(a,b){this.promo=b.promo}}),LocationsCollection=LocallyStoredCollection.extend({key:"yelp.locations",initialize:function(){var a=this;framework.extension.attachEvent("LocationsCollection",function(b,c){a.search(b.data.query,b.data.source).then(function(a){return c(a.toJSON())})}),this.fetch()},search:function(a,b){var c=this;return new Promise(function(d,e){a?a.id?(d(c.add(a)),c.save()):c.get(a)?d(c.get(a)):(stat(["_trackEvent",b,"Request Google",a]),$.ajax({url:"http://maps.google.com/maps/api/geocode/json",data:{address:a},success:function(b){b&&b.results&&b.results.length&&(d(c.add(_.extend({id:a},b.results[0].geometry.location))),c.save())}})):e()})}});new(Backbone.Collection.extend({url:"https://api.groupon.com/v2/deals/search",initialize:function(){var a=this;this.locations=new LocationsCollection,framework.extension.attachEvent("GrouponDealsCollection",function(b,c){b.data.query&&a.search(b.data).then(function(){c(a.toJSON())})})},search:function(a){var b=this;return this.locations.search(a.location,a.source).then(function(c){return stat(["_trackEvent",a.source,"Request Groupon",a.query]),b.fetch({data:{limit:a.limit||100,show:"id,dealUrl,announcementTitle,title,options,merchant,grid4ImageUrl",other_deals:!0,locale:"en_US",offset:0,metadata:!1,client_id:"0c9926ce2479a25adec0c9b3c1e6327c73946fe7",tsToken:"US_AFF_0_200014_200067_0",secure_assets:!1,query:a.query,lng:c.get("lng"),lat:c.get("lat")}})})},parse:function(a){return _.map(a.deals,function(a){return _.extend({locations:_.flatten(_.map(a.options,function(a){return _.map(a.redemptionLocations,function(a){return _.pick(a,"streetAddress1","city","state","postalCode","phoneNumber")})}))},_.pick(a,"id","dealUrl","announcementTitle","title","grid4ImageUrl","options"),_.pick(a.merchant,"name","websiteUrl"))})}})),function(){var a=function a(b){var c=this;_classCallCheck(this,a);var d=function(a,b){return a+Math.floor(Math.random()*(b-a))},e=b||{},f=1,g=d(1e7,99999999),h=d(1e9,9999999999),i=d(1e9,2147483647),j=(new Date).getTime();this.send=function(a){var b=_.extend({utmwv:"5.3.7",utms:f++,utmn:h,utmhn:"",utmcs:"-",utmsr:screen.availWidth+"x"+screen.availHeight,utmsc:"-",utmul:navigator.language,utmje:"1",utmfl:"-",utmhid:"467839945",utmr:"-",utmac:"",utmcc:"__utma="+g+"."+i+"."+j+"."+j+"."+j+".65;+__utmz="+g+"."+j+".1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none);",utmu:"6~"},e);if("_trackEvent"===a[0]){a.splice(0,1);var c=a.splice(4).pop()||"/background.html",d=a.splice(3).pop()||null;$.extend(b,{utmt:"event",utme:"5("+a.join("*")+")"+(null!==d?"("+d+")":""),utmp:c})}else $.extend(b,{utmp:a[1],utmdt:a[2]});var k="https://www.google-analytics.com/__utm.gif?"+$.param(b).replace(/\+/g,"%20");return new Promise(function(a,b){var c=new Image;c.src=k,c.onload=a,c.onerror=b})},framework.extension.attachEvent("ga",function(a){c.send.apply(c,a.data).catch(function(a){})})},b=new a({utmac:"UA-35458890-1",utmhn:"ebates.com"});window.stat=function(a){return b.send(a).catch(function(a){})},framework.extension.attachEvent("GAEvent",function(a){b.send(["_trackEvent",a.data.category,a.data.action,a.data.label,a.data.value,a.data.page]).catch(function(a){})}),framework.extension.attachEvent("GAPage",function(a){b.send(["_trackPageview",a.data.page,a.data.title]).catch(function(a){})})}(window),function(){var a=Backbone.Model.extend({}),b=Backbone.Collection.extend({model:a,update:function(a){var b=this.findWhere({tabId:a.tabId});a.name,delete a.name,b?b.set(a):this.push(a)},remove:function(a){var b=this.findWhere({tabId:a.tabId});b&&b.destroy()}});window.tabs=new b,framework.browser.attachEvent(framework.browser.DOCUMENTCOMPLETE,function(a){window.tabs.update(a)}),framework.browser.attachEvent(framework.browser.TABCHANGED,function(a){window.tabs.update(a)}),framework.browser.attachEvent(framework.browser.TABCLOSED,function(a){window.tabs.remove(a)})}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},icons={};"Safari"===framework.browser.name?icons={neutral:"img/safari/icon@2x.png",activated:"img/safari/icon-activated@2x.png",available:"img/safari/icon-available@2x.png"}:"Edge"===framework.browser.name&&(icons={neutral:{20:"img/ie/icon-20.png",40:"img/ie/icon-40.png",38:"img/ie/icon-40.png"},activated:{20:"img/ie/icon-activated-20.png",40:"img/ie/icon-activated-40.png",38:"img/ie/icon-activated-40.png"},available:{20:"img/ie/icon-available-20.png",40:"img/ie/icon-available-40.png",38:"img/ie/icon-available-40.png"}});var StringModel=Backbone.Model.extend({constructor:function(a){return Backbone.Model.call(this,{data:a})},toJSON:function(){return this.get("data")}}),BlackList=LocallyStoredCollection.extend({key:"blacklist",model:StringModel,initialize:function(){var a=this;framework.extension.attachEvent("blacklist-save",function(b){a.reset(b.data),a.save()})},contains:function(a){return!!this.find(function(b){return Utils.getDomain(a)===Utils.getDomain(b.get("data"))})}}),TAFSettingsModel=CachedModel.extend({timeout:432e5,defaults:{referPageTitle:"Get $5+",referPageMessage:"See website for full terms & conditions.",referBonusAmount:"$5+",referStoreDetailTitle:"It Pays to Share",referStoreDetailMessage:"Refer a friend to Ebates and get $5+!",referImageToolbar:"/toolbar/images/taf_toolbar.png",referImageToolbar2x:"/toolbar/images/taf_toolbar@2x.png",referDefaultPersonalMessage:"Have you heard of Ebates? It's awesome. I use Ebates to get Cash Back on almost everything I buy. They work with a bunch of big-name brands like Kohl's, Nordstrom, and Amazon so I can always get money back from my favorite stores. It's free and super easy to use. Check it out!"},url:function(){return substitute(URL.SETTINGS_TAF)},toJSON:function(){var a=CachedModel.prototype.toJSON.apply(this,arguments);return window.devicePixelRatio>1&&(a.referImageToolbar=a.referImageToolbar2x),a}}),CouponsCollection=DynamicCollection.extend({model:Backbone.Model,UPDATE_INTERVAL:864e5,url:function(){return substitute(URL.SETTINGS_COUPONS)},initialize:function(){var a=this;return framework.extension.attachEvent("getCouponsConfig",function(b,c){c({config:a.toJSON(),debug:DEBUG})}),DynamicCollection.prototype.initialize.apply(this,arguments)},parse:function(a){return a.coupons}}),CheckoutPagesCollection=DynamicCollection.extend({model:Backbone.Model,UPDATE_INTERVAL:864e5,url:function(){return substitute(URL.SETTINGS_CHECKOUT)},initialize:function(){var a=this;return framework.extension.attachEvent("getCheckoutConfig",function(b,c){c(_.invoke(a.where({storeId:b.data.storeId}),"toJSON"))}),DynamicCollection.prototype.initialize.apply(this,arguments)}}),CheckoutNotificationsSettings=LocallyStoredModel.extend({key:"cart_notifications",defaults:{activation:!0,caa:!0,ccch:!0,ccps:!0,bonus:!0}}),SettingsModel=LocallyStoredModel.extend({key:"settings",blacklist:new BlackList,refsettings:new TAFSettingsModel,promos:new PromosCollection,coupons:new CouponsCollection,checkoutPages:new CheckoutPagesCollection,checkoutNotifications:new CheckoutNotificationsSettings,affiliates:new AffiliateLinkStatus,serp:[],ordersIgnoreList:["Uber","Lyft","Eat24","OpenTable"],updateInterval:864e5,defaults:{serpEnabled:!0,serpOffersEnabled:!0,loggingEnabled:!1,blacklistEnabled:!1,ccHover:0,features:{},groupon:{},buttonImage:"https://www.ebates.com/toolbar/images/icon76x76.png"},update:function(){var a=this;(!this.updateTime||_.now()>this.updateTime+this.updateInterval)&&$.ajax({cache:!0,url:substitute(URL.SETTINGS),dataType:"json",error:function(){a.updateTimeout=window.setTimeout(_.bind(a.update,a),3e5)},success:function(b){a.checkoutNotifications.set(b.checkoutNotifications),a.affiliates.suppresses.set(b.paidLinks),a.serp=b.serp,a.set({features:b.features,groupon:b.groupon}),a.promos.set(b.promos),b.ordersIgnoreList&&(a.ordersIgnoreList=b.ordersIgnoreList),a.domains=_.map(b.domains,function(a){return a.track_events=!0,a}),b.domains&&EBATES.merchants.length&&(EBATES.merchants?EBATES.merchants.add(b.domains,{merge:!0}):EBATES.merchants.once("sync",function(){EBATES.merchants.add(b.domains,{merge:!0})})),a.updateTime=_.now(),a.updateTimeout=window.setTimeout(_.bind(a.update,a),36e5)}})},initialize:function(){var a=this;this.productParsers=new window.ProductParsersCollections,this.promos.fetch(),this.update(),this.fetch(),this.blacklist.fetch(),this.coupons.fetch({dataType:"json"}).catch(function(){}),this.checkoutPages.fetch({dataType:"json"}).catch(function(){}),this.on("change:ordersDisabled",function(a,b){b&&(EBATES.member.orders.unset("access_token"),EBATES.member.orders.save())}),framework.extension.attachEvent("settings",function(b,c){b.data&&a.save(b.data),c&&c(a.toJSON())})},toJSON:function(){return _.extend(LocallyStoredModel.prototype.toJSON.apply(this,arguments),{checkoutNotifications:this.checkoutNotifications.toJSON(),ordersAvailable:!!EBATES.member.get("oneReceiptEnabled")&&"Chrome"===framework.browser.name,serp:this.serp,blacklist:this.blacklist.toJSON(),refsettings:this.refsettings.toJSON(),promos:this.promos.toJSON(),domain:domain})}}),_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),toolbarId=null,installVersion=null,autoLoginId=null,currentUrl="",currentTab=0,EBATES=null;window.webext=window.browser||window.chrome;var EbatesApp=function(){function a(b){_classCallCheck(this,a),$.ajaxSetup({headers:{"X-Button-Version":framework.extension.version}}),this.trackingTicketNumber=null,this.sessionReward=null,this.errors=new ErrorsCollection,this.merchants=new MerchantsCollection,this.settings=new SettingsModel,this.icon=new AnimatedIcon,this.member=new MemberDetailsModel,this.init(),framework.extension.attachEvent("getOffers",function(a,b){if(a.data.search){var c=EBATES.merchants.find(function(b){return b.get("settings_deals")&&0===b.get("storeName").toLowerCase().indexOf(a.data.search)});c.length>0&&c.deals.fetch().then(function(){b({offers:c.deals.toJSON(),merchant:c.toJSON()})})}else{var d=EBATES.merchants.findWhere({storeId:a.data.storeId});d&&d.get("settings_deals")&&d.deals.fetch().catch(function(){}).then(function(){b({offers:d.deals.toJSON()})})}}),framework.extension.attachEvent("openOptionsPage",function(a){Utils.openOptionsPage()}),framework.extension.attachEvent("CopyToClipboard",function(a){Utils.CopyToClipboard(a.data)})}return _createClass(a,[{key:"init",value:function(){autoLoginId?(framework.ui.button.detachEvent(framework.ui.button.CLICK,login),framework.ui.button.setPopup({url:"popup/popup.html",width:380,height:493}),["Chrome","Edge"].includes(framework.browser.name)&&framework.extension.getItem("walkthrough",function(a){0===a&&framework.browser.navigate({url:webext.extension.getURL("html/walkthrough.html"),tabId:framework.browser.NEWTAB})}),this.member.fetch({reset:!0}),this.ping()):(framework.ui.button.setPopup(),framework.ui.button.attachEvent(framework.ui.button.CLICK,login))}},{key:"activate",value:function(a,b,c){_.invoke(EBATES.merchants.where(a.pick("storeId")),"set",{state:"activated",activation_source:c.get("xfas_source")||a.get("activation_source"),ttn:EBATES.trackingTicketNumber||a.get("ttn"),sessionReward:EBATES.sessionReward&&(EBATES.sessionReward.amount||EBATES.sessionReward.range)&&!_.isEqual(a.get("totalReward"),EBATES.sessionReward)?EBATES.sessionReward:null},{tabId:b}),this.trackingTicketNumber=null,this.sessionReward=null,b==currentTab&&a.get("settings_icon")&&!a.get("suppressed")&&a.get("activated")&&this.icon.play({type:"activated",count:5})}},{key:"ping",value:function(){framework.extension.getItem("ga_usage",function(a){var b=new Date(parseInt(a||0,10)),c=new Date;c.getTime()-b.getTime()>=864e5&&(window.stat(["_trackEvent","Extension","Ping",framework.extension.version]),framework.extension.setItem("ga_usage",c.getTime().toString())),window.setTimeout(function(){EBATES.ping()},36e5)})}},{key:"loggedIn",get:function(){return autoLoginId}}]),a}();framework.browser.attachEvent(framework.browser.DOCUMENTCOMPLETE,function(a){handlePage(_.extend({name:framework.browser.DOCUMENTCOMPLETE},a))}),framework.browser.attachEvent(framework.browser.TABCHANGED,function(a){handlePage(_.extend({name:framework.browser.TABCHANGED},a))}),framework.browser.attachEvent(framework.browser.BEFORENAVIGATE,function(a){EBATES&&a.url&&EBATES.settings.affiliates.match(a.url,a.tabId)}),framework.extension.attachEvent("autoLoginId",function(a){var b=a.data;autoLoginId!=b&&(autoLoginId=b,framework.extension.setItem("autoLoginId",autoLoginId),framework.extension.setItem("UserId",null),EBATES.init())}),framework.extension.getItem(["toolbarId","autoLoginId","domain","api"],function(a){if(a.domain&&(domain=a.domain),a.api&&(api=a.api),a.autoLoginId?autoLoginId=a.autoLoginId:"Firefox"===framework.browser.name&&$.get("http://ebates.com").then(function(a){var b=a.match(/ebates\.user\.id = decodeURIComponent\("(.*?)"\);/);b&&b.length&&(autoLoginId=b[1],framework.extension.setItem("autoLoginId",autoLoginId),EBATES.init())}),a.toolbarId)toolbarId=a.toolbarId,framework.extension.getItem("installVersion",function(a){installVersion=a});else{toolbarId=Math.floor(1e9*Math.random(1)),installVersion=framework.extension.version,window.stat(["_trackEvent","ExtensionInstalled",framework.browser.name,"Ebates"]),framework.extension.setItem("toolbarId",toolbarId),framework.extension.setItem("installVersion",framework.extension.version),framework.extension.setItem("notification-explanation",0),framework.extension.setItem("walkthrough",0),framework.browser.navigate({url:substitute(URL.WEB_INSTALL)});var b=function a(b){EBATES.log({event_type:"install",eb_session_id:b.data,autologin_id:autoLoginId,browser_agent:navigator.userAgent,button_version:framework.extension.version}),framework.extension.detachEvent("sessionId",a)};framework.extension.attachEvent("sessionId",b)}EBATES=new EbatesApp}),framework.extension.attachEvent("login",login),["Chrome","Edge","Firefox"].includes(framework.browser.name)&&(webext&&webext.webNavigation&&webext.webNavigation.onCommitted.addListener(function(a){if("typed"==a.transitionType&&EBATES&&EBATES.merchants){EBATES.settings.affiliates.clear(a.tabId);var b=EBATES.merchants.match(a.url);b&&(_.invoke(EBATES.merchants.where(b.pick("storeId")),"unset","state",{tabId:a.tabId}),a.tabId===currentTab&&EBATES.icon.stop("available"))}}),"ebates"===framework.extension.filename&&webext.runtime.setUninstallURL&&webext.runtime.setUninstallURL(substitute(URL.WEB_UNINSTALL))),EbatesApp.prototype.captureOrderPage=function(a){return $.ajax({method:"POST",contentType:"application/json",processData:!1,url:substitute(URL.CAPTURE_ORDER),data:new Uint8Array(new window.pako.gzip(JSON.stringify(a))),beforeSend:function(a){a.setRequestHeader("Content-Encoding","gzip"),a.setRequestHeader("X-Button-Version",framework.extension.version)}})},framework.extension.attachEvent("CaptureOrderPage",function(a){a.data.merchant.ttn&&EBATES.captureOrderPage({source_name:"toolbar",store_name:a.data.merchant.storeName,store_id:a.data.merchant.storeId,shopping_trip_id:(DEBUG?"qbs":"ebs")+a.data.merchant.ttn+(DEBUG?"sbq":"sbe"),content_source:a.url,content_type:"order confirmation",content_format:"html",client_type:framework.browser.name.toLowerCase(),client_version:framework.extension.version,content:a.data.content,load_time:a.data.load_time,javascript_error:a.data.javascript_error})}),framework.extension.attachEvent("interstitial",function(a){EBATES.trackingTicketNumber=a.data.trackingTicketNumber,EBATES.sessionReward=a.data.sessionReward,EBATES.session_event&&(EBATES.log(_.extend(EBATES.session_event,{tracking_ticket:EBATES.trackingTicketNumber})),EBATES.session_event=null)}),EbatesApp.prototype.logCloseSession=function(){EBATES.session_id&&$.ajax({method:"POST",url:URL.LOG,data:$.param({event_type:"session_end_event",session_id:EBATES.session_id,url:window.currentUrl,created_ts:function(){return moment().format("DDMMYYYY HHmmss")}(),tenant:"ebates.com"})+"&",success:function(){EBATES.session_id=null,EBATES.session_event=null}})},EbatesApp.prototype.log=function(a){var b=this,c="",d=function(){return moment().format("DDMMYYYY HHmmss")},e=function(){if(!b.session_id)switch(a.event_type){case"activated_ebates_com":case"non_cb_visit":case"icon_click_non_merchant_open":case"slider_open":case"icon_click_merchant_open":case"serp_with_button_label":case"Nordstrom_no_CB_homepage":return b.session_id=toolbarId+"||"+moment().format("YYYYMMDDhhmmss"),$.when(h()).then(function(){return $.ajax({method:"POST",url:URL.LOG,data:$.param({event_type:"session_start_event",browser_agent:navigator.userAgent,user_id:EBATES.member.get("id"),autologinid:autoLoginId,source:"Button",button_version:framework.extension.version,session_id:b.session_id,url:a.url||window.currentUrl,created_ts:d(),ip_address:null,canonical_url:c,tenant:"ebates.com"})+"&"})})}},f=function(){switch(a.event_type){case"member_info_click":case"icon_click_non_merchant_close":case"icon_click_merchant_close":case"search":case"ebates_logo":case"close":}},g=function(){switch(a.event_type){case"activate_slider":case"activate_widget":if(!a.tracking_ticket)return void(b.session_event=_.extend({session_id:b.session_id,created_ts:d(),url:window.currentUrl,tenant:"ebates.com"},_.pick(a,_.identity)));default:return $.ajax({method:"POST",url:URL.LOG,data:$.param(_.extend({session_id:b.session_id,created_ts:d(),url:window.currentUrl,tenant:"ebates.com"},_.pick(a,_.identity)))+"&"})}},h=function(){return new Promise(function(a){if(c)a();else{var b=_.delay(function(){a("")},500);framework.extension.fireEvent("getCanonicalURL",{tabId:currentTab},function(d){d&&(c=d),window.clearTimeout(b),a(d)})}})};return $.when(h).then(e).then(g).then(f)},framework.extension.attachEvent("InternalLoggingEvent",function(a){EBATES.log($.extend({url:a.url},a.data))}),framework.extension.attachEvent("console.log",function(a){}),framework.browser.attachEvent(framework.browser.DOCUMENTCOMPLETE,function(a){if(EBATES){window.clearTimeout(EBATES.session_timeout),EBATES.session_id&&(EBATES.session_timeout=window.setTimeout(EBATES.logCloseSession,18e5));var b=Utils.getDomain(a.url);["shopathome.com","shopstyle.com","dealmoon.com","mrrebates.com","retailmenot.com","dealsplus.com","jet.com"].includes(b)&&(EBATES.session_competition={event_type:"competitive_visit",location_flag:"competition",url:a.url,domain:b})}}),function(){function a(){function a(a,c,f){var g=(new Date).toGMTString(),h=a+"\n\n"+(c||"")+"\n\nx-amz-date:"+g+"\n/"+b+"/"+f;return{Authorization:"AWS "+d+":"+CryptoJS.enc.Base64.stringify(CryptoJS.HmacSHA1(h,e)),"x-amz-date":g}}var b="ebates-pages-store",c="https://"+b+".s3.amazonaws.com/",d="AKIAIF6APH57A3IQLKUQ",e="+tjwfxTPT3kRh+gxno7FwDn74dTDmK8I10hFoMZu";this.putFile=function(b){var d=b.filename,e=b.content,f=b.callback,g=void 0===f?function(){}:f;return $.ajax({url:c+d,type:"PUT",contentType:"text/plain; charset=UTF-8",data:e,headers:a("PUT","text/plain; charset=UTF-8",d)}).done(function(a){g(c+d)})}}var b=new a;framework.extension.attachEvent("uploadFile",function(a){b.putFile({path:"/",filename:"<user_id>_<merchant_id>_<page_type>_<extension_type>_<tripid>_<timestamp>.html".replace("<merchant_id>",1).replace("<user_id>",EBATES.member.id).replace("<page_type>",a.data.page_type).replace("<extension_type>",framework.browser.name.charAt(0)).replace("<tripid>",0).replace("<timestamp>",_.now()),content:a.data.content,callback:function(a){EBATES.session_id||(EBATES.session_id=toolbarId+"||"+moment().format("YYYYMMDDhhmmss")),EBATES.log({event_type:"orderconf",session_id:EBATES.session_id,filename:a,merchant_id:1,autologin_id:autoLoginId,created_ts:function(){return moment().format("DDMMYYYY HHmmss")}()}),window.stat(["_trackEvent","Slice","Order Conf"])}})})}(window);